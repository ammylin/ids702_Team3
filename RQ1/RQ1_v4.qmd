---
title: "Global Happiness Analysis"
subtitle: "Arvind Kandala, Ammy Lin, Lingyue Hao, Shelly Cao"
execute:
  echo: false
  message: false
  warning: false
editor: visual
format: pdf
---

## Load data

```{r}
library(tidyverse)
library(dplyr)
library(broom)
library(knitr)
library(kableExtra)
library(ggplot2)
library(dplyr)

happiness <- read.csv("https://github.com/lingyuehao/ids702_Team3/raw/refs/heads/main/data/2015_2019_combined.csv")

happiness <- happiness %>%
rename(
country = Country,
region = Region,
score = Happiness.Score,
gdp_index = Economy..GDP.per.Capita.,
lifeexp_index = Health..Life.Expectancy.,
freedom_index = Freedom,
generosity_index = Generosity,
year = Year
)

glimpse(happiness)
head(happiness)


```

### **Research Question 1: Life Expectancy, GDP, and Happiness**

Is there a significant association between life expectancy and national happiness, after adjusting for GDP per capita?

### **Model Specification:**

We fit a multiple linear regression model with a national happiness score as the outcome; a linear regression model is appropriate here because the outcome (happiness score) is continuous and approximately normally distributed. The linear model relies on several core assumptions: (1) the relationship between predictors and the outcome is linear, (2) residuals have constant variance across fitted values, (3) residuals are independent, and (4) residuals are approximately normally distributed. 

The formal model is specified as follows:

$$
\text{Score}_i = \beta_0 + \beta_1(\text{LifeExp}_i) + \beta_2(\text{GDP}_i) + \beta_3(\text{LifeExp}_i \times \text{GDP}_i) + \epsilon_i
$$

Life expectancy index and GDP index were included as primary predictors, and we added an interaction between them to explore whether the association between life expectancy and happiness varies depending on a country’s economic status. Including the interaction allowed us to more fully capture the relationship between these two structural indicators while controlling for potential confounding between them. Put another way, the interaction between life expectancy and GDP per capita was included because the relationship between health outcomes and happiness is likely to differ depending on a country's level of economic development. Wealthier countries may benefit more from additional life expectancy gains due to differences in healthcare quality, social safety nets, or elderly well-being.

GDP was included as a covariate because it is plausibly associated with both happiness and life expectancy, making it a potential confounder. Excluding it would risk overstating the independent contribution of life expectancy to national happiness. Additional unmeasured confounders, such as education levels or political stability, should be acknowledged as possible sources of residual bias. 

```{r}
rq1_model <- lm(
  score ~ lifeexp_index * gdp_index,
  data = happiness
)

coef_df <- summary(rq1_model)$coefficients
adj_r2 <- summary(rq1_model)$adj.r.squared
r2_value <- summary(rq1_model)$r.squared

rq1_table <- tidy(rq1_model, conf.int = TRUE) %>%
  select(term, estimate, std.error, statistic, p.value, conf.low, conf.high) %>%
  mutate(
    term = recode(
      term,
      "(Intercept)" = "Intercept",
      "lifeexp_index" = "Life expectancy index",
      "gdp_index" = "GDP per capita index",
      "lifeexp_index:gdp_index" = "Life expectancy × GDP per capita"
    ),
    p.value = ifelse(p.value < 0.001, "<0.001",
                     sprintf("%.3f", round(p.value, 3))),
    estimate = sprintf("%.3f", round(estimate, 3)), 
    std.error = sprintf("%.3f", round(std.error, 3)),
    statistic = sprintf("%.3f", round(statistic, 3)),
    conf.low = sprintf("%.3f", round(conf.low, 3)),
    conf.high = sprintf("%.3f", round(conf.high, 3))
  )

rq1_table <- bind_rows(
  rq1_table,
  tibble(
    term = c("R-squared", "Adjusted R-squared"),
    estimate = c(sprintf("%.3f", round(r2_value, 3)),
                 sprintf("%.3f", round(adj_r2, 3))),
    std.error = "",
    statistic = "",
    p.value = "",
    conf.low = "",
    conf.high = ""
  )
)

colnames(rq1_table) <- c(
  "Variable", "Estimate", "Std Error", "t-value", "p-value",
  "Lower 95% CI", "Upper 95% CI"
)

kable(
  rq1_table,
  caption = "Linear regression model for national happiness",
  digits = 3,
  booktabs = TRUE,
  linesep = "",
  align = c("l", "c", "c", "c", "c", "c", "c")
)


```

From Table 1, we see that GDP per capita remains the strongest predictor of national happiness after controlling for life expectancy. Its coefficient is fairly large (≈ 0.63) and highly significant (p \< 0.001), and the 95% confidence interval \[0.302, 0.966\] excludes zero. This indicates a robust positive association: countries with higher GDP per capita consistently report higher levels of happiness, even after adjusting for differences in life expectancy. 

In contrast, the main effect for life expectancy is small (≈ 0.21) and not statistically significant (p = 0.425). Its 95% confidence interval spans both negative and positive values \[–0.299, 0.708\], which suggests that life expectancy alone is not clearly associated with happiness once GDP per capita has been taken into account. This suggests that longevity, by itself, may not meaningfully affect self-reported well-being in the absence of any economic context.

However, the interaction term between life expectancy and GDP per capita (≈ 1.50, p \< 0.001) is positive, large, and statistically strong. Its confidence interval \[1.008, 1.990\] is above zero, indicating a reliably positive interaction. This means that the relationship between life expectancy and happiness becomes substantially stronger in higher-income countries. In practical terms, living longer appears to contribute more to national happiness in places where economic conditions are already favorable; thus, increases in longevity translate into higher well-being when supported by adequate economic resources, social infrastructure, and living standards.

```{r}
library(ggplot2)
library(dplyr)

life_exp_range <- seq(min(happiness$lifeexp_index), max(happiness$lifeexp_index), length.out = 100)

# Define the specific GDP levels based on 'gdp_index'
gdp_levels <- c(
  "Low GDP" = quantile(happiness$gdp_index, 0.1),
  "Average GDP" = mean(happiness$gdp_index),
  "High GDP" = quantile(happiness$gdp_index, 0.9)
)

plot_data <- data.frame()

for(level_name in names(gdp_levels)) {
  temp_df <- data.frame(
    lifeexp_index = life_exp_range,
    gdp_index = gdp_levels[[level_name]],
    GDP_Level = level_name
  )
  plot_data <- rbind(plot_data, temp_df)
}

preds <- predict(rq1_model, newdata = plot_data, interval = "confidence")
plot_data <- cbind(plot_data, preds)

ggplot(plot_data, aes(x = lifeexp_index, y = fit, color = GDP_Level, fill = GDP_Level)) +
  geom_line(linewidth = 1.2) + 
  geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = 0.2, color = NA) +
  theme_minimal() +
  labs(
    title = "Interaction of Life Expectancy and GDP on Happiness",
    subtitle = "Life Expectancy matters more for happiness in wealthy nations",
    x = "Life Expectancy Index",
    y = "Predicted Happiness Score",
    color = "Economic Status",
    fill = "Economic Status"
  ) +
  scale_color_manual(values = c("Low GDP" = "#d73027", "Average GDP" = "#fee090", "High GDP" = "#4575b4"))
```

To visualize this dynamic, the above figure plots the predicted happiness scores against life expectancy at three distinct levels of economic development. Analyzing the differences in slopes, we see that the steep slope of the "High GDP" line (green) confirms that in wealthy nations, improvements in life expectancy are strongly coupled with sharp increases in happiness. Conversely, the "Low GDP" line (blue) is markedly flatter, indicating that in lower-income contexts, gains in life expectancy yield only modest improvements in perceived well-being. Situated between these extremes, the "Average GDP" line (yellow) demonstrates a moderate baseline relationship, confirming that while longevity generally boosts happiness, the magnitude of this benefit is heavily constrained by economic context. This "fanning out" pattern suggests a synergistic effect where health and wealth together produce the highest levels of national satisfaction.

### **Model Assessment:**

```{r}
par(mfrow = c(2,2),         
    mar = c(4,4,2,1),      
    cex = 0.9,              
    cex.axis = 0.9,         
    cex.lab = 0.9,          
    cex.main = 1.1)      

plot(rq1_model)
```

We assessed the model using standard diagnostic plots. Based on the four diagnostic plots for our linear model, all of the assumptions are reasonably supported, although a few areas need caution. The residuals-versus-fitted plot shows points scattered fairly evenly around zero without a strong pattern, which suggests that the linearity assumption is mostly acceptable. The Q–Q plot is fairly close to the 45-degree line, especially in the center of the distribution, so the normality assumption is not perfect—there is some deviation in the tails—but the overall pattern is still acceptable for a model of this size. The scale–location plot shows a generally horizontal trend, but with some spread increasing slightly at higher fitted values, which hints at mild heteroskedasticity, though not severe enough to invalidate the model. Finally, the residuals-versus-leverage plot identifies a few observations with higher leverage (for example, points around leverage \> 0.02), but none clearly exceed Cook’s distance, so influential points do not appear to be a major issue. 

Because model diagnostics showed only mild heteroskedasticity and no strongly influential points, no adjustments (e.g., variable transformation or robust standard errors) were made. The model was retained in its original form.

Likewise, we evaluated the potential for multicollinearity using the Variance Inflation Factor (VIF). As is common in models with interaction terms, the initial VIF for the interaction term was high (VIF = 21.45), indicating structural multicollinearity introduced by the product of the predictors. To confirm that this was not symptomatic of problematic data correlation, we mean-centered the predictors and re-assessed the model. The resulting VIF values for all terms dropped below 3 (Max VIF = 2.65), confirming that multicollinearity does not bias the model's stability or the validity of the interaction effect.

Additionally, the model explains a substantial portion of the variation in national happiness (Adjusted R² = 0.6762), indicating that nearly 68% of the differences in happiness across countries can be accounted for by life expectancy, GDP per capita, and their interaction.

```{r}
library(car)

vif_initial <- vif(rq1_model)

# Create centered variables to eliminate structural multicollinearity induced by the interaction term 
# We know structural multicollinearity exists because after creating these centered variables, the VIF droppped significantly
happiness <- happiness %>%
  mutate(
    lifeexp_centered = lifeexp_index - mean(lifeexp_index, na.rm = TRUE),
    gdp_centered = gdp_index - mean(gdp_index, na.rm = TRUE)
  )

# Re-fit model with centered variables
rq1_model_centered <- lm(score ~ lifeexp_centered * gdp_centered, data = happiness)

vif_centered <- vif(rq1_model_centered)

vif_table <- data.frame(
  Predictor = names(vif_centered),
  VIF = vif_centered
)

kable(vif_table, caption = "Variance Inflation Factor (VIF) for Centered Model") %>%
  kable_styling(full_width = F)
```
