rq1_model <- lm(
score ~ lifeexp_index * gdp_index +
lifeexp_index * year +
gdp_index * year +
family_index +
freedom_index +
trust_index +
generosity_index +
year,
data = happiness
)
model_summary <- summary(rq1_model)
r2_value <- model_summary$r.squared
adj_r2   <- model_summary$adj.r.squared
cluster_vcov <- sandwich::vcovCL(rq1_model, cluster = ~ country)
coefs_robust <- lmtest::coeftest(rq1_model, vcov = cluster_vcov)
crit_val <- qt(0.975, df = rq1_model$df.residual)
rq1_table <- data.frame(
term      = rownames(coefs_robust),
estimate  = coefs_robust[, "Estimate"],
std.error = coefs_robust[, "Std. Error"],
statistic = coefs_robust[, "t value"],
p.value   = coefs_robust[, "Pr(>|t|)"],
stringsAsFactors = FALSE
) %>%
mutate(
conf.low  = estimate - crit_val * std.error,
conf.high = estimate + crit_val * std.error
) %>%
mutate(
term = dplyr::recode(
term,
"(Intercept)"              = "Intercept",
"lifeexp_index"           = "Life expectancy index",
"gdp_index"               = "GDP per capita index",
"family_index"            = "Family index",
"freedom_index"           = "Freedom index",
"trust_index"             = "Trust index",
"generosity_index"        = "Generosity index",
"year"                    = "Year",
"lifeexp_index:gdp_index" = "Life expectancy × GDP per capita",
"lifeexp_index:year"      = "Life expectancy × Year",
"gdp_index:year"          = "GDP per capita × Year"
),
p.value   = ifelse(p.value < 0.001, "<0.001",
sprintf("%.3f", round(p.value, 3))),
estimate  = sprintf("%.3f", round(estimate, 3)),
std.error = sprintf("%.3f", round(std.error, 3)),
statistic = sprintf("%.3f", round(statistic, 3)),
conf.low  = sprintf("%.3f", round(conf.low, 3)),
conf.high = sprintf("%.3f", round(conf.high, 3))
)
rq1_table <- dplyr::bind_rows(
rq1_table,
tibble::tibble(
term      = c("R-squared", "Adjusted R-squared"),
estimate  = c(sprintf("%.3f", round(r2_value, 3)),
sprintf("%.3f", round(adj_r2, 3))),
std.error = "", statistic = "", p.value = "",
conf.low  = "", conf.high = ""
)
)
colnames(rq1_table) <- c(
"Variable", "Estimate", "Std Error", "t-value", "p-value",
"2.5% CI", "97.5% CI"
)
rownames(rq1_table) <- NULL
kable(
rq1_table,
caption = "Linear regression model for national happiness (cluster–robust SEs by country)",
booktabs = TRUE,
longtable = FALSE,
linesep  = "",
align    = c("l", "c", "c", "c", "c", "c", "c")
) %>%
kableExtra::kable_styling(full_width = FALSE, font_size = 10)
par(mfrow = c(2,2),
mar = c(4,4,2,1),
cex = 0.9,
cex.axis = 0.9,
cex.lab = 0.9,
cex.main = 1.1)
plot(rq1_model)
vif_initial <- vif(rq1_model)
happiness <- happiness %>%
mutate(
lifeexp_centered = lifeexp_index - mean(lifeexp_index, na.rm = TRUE),
gdp_centered = gdp_index - mean(gdp_index, na.rm = TRUE)
)
rq1_model_centered <- lm(score ~ lifeexp_centered * gdp_centered, data = happiness)
vif_centered <- vif(rq1_model_centered)
vif_table <- data.frame(
Predictor = names(vif_centered),
VIF = vif_centered
)
#Ordinal Regression Model and Robust Standard Errors
happiness <- happiness %>%
filter(
!is.na(region),
region != "",
!is.na(score),
!is.na(generosity_index),
!is.na(freedom_index),
!is.na(family_index),
!is.na(trust_index),
!is.na(lifeexp_index),
!is.na(gdp_index),
!is.na(year)
)
region_avg <- happiness %>%
group_by(region) %>%
summarize(
avg_happiness = mean(score, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(
happy_group_num = ntile(avg_happiness, 3),
Region_Happy_Group = case_when(
happy_group_num == 1 ~ "Low",
happy_group_num == 2 ~ "Medium",
happy_group_num == 3 ~ "High"
),
Region_Happy_Group = factor(
Region_Happy_Group,
levels = c("Low", "Medium", "High"),
ordered = TRUE
)
)
happiness_ord <- happiness %>%
left_join(
region_avg %>% dplyr::select(region, Region_Happy_Group),
by = "region"
) %>%
filter(!is.na(Region_Happy_Group))
rq2_model <- polr(
Region_Happy_Group ~
generosity_index * freedom_index +
lifeexp_index +
gdp_index +
family_index +
trust_index +
year,
data = happiness_ord,
Hess = TRUE
)
vcov_region <- sandwich::vcovCL(rq2_model, cluster = ~ region)
param_names   <- rownames(vcov_region)
se_robust_all <- sqrt(diag(vcov_region))
names(se_robust_all) <- param_names
ctable <- coef(summary(rq2_model))
se_robust <- se_robust_all[rownames(ctable)]
z_robust <- ctable[, "Value"] / se_robust
p_robust <- 2 * (1 - pnorm(abs(z_robust)))
ctable_robust <- cbind(
"Value"      = ctable[, "Value"],
"Std. Error" = se_robust,
"t value"    = z_robust,
"p value"    = p_robust
)
#Coefficient Table
crit_val <- qnorm(0.975)
rq2_table <- data.frame(
term      = rownames(ctable_robust),
estimate  = ctable_robust[, "Value"],
std.error = ctable_robust[, "Std. Error"],
statistic = ctable_robust[, "t value"],
p.value   = ctable_robust[, "p value"],
stringsAsFactors = FALSE
) %>%
mutate(
conf.low  = estimate - crit_val * std.error,
conf.high = estimate + crit_val * std.error
) %>%
mutate(
term = dplyr::recode(
term,
"generosity_index"               = "Generosity index",
"freedom_index"                  = "Freedom index",
"lifeexp_index"                  = "Life expectancy index",
"gdp_index"                      = "GDP per capita index",
"family_index"                   = "Family index",
"trust_index"                    = "Trust index",
"year"                           = "Year",
"generosity_index:freedom_index" = "Generosity × Freedom",
"Low|Medium"                     = "Cutpoint: Low | Medium",
"Medium|High"                    = "Cutpoint: Medium | High"
),
p.value   = ifelse(p.value < 0.001, "<0.001",
sprintf("%.3f", round(p.value, 3))),
estimate  = sprintf("%.3f", round(estimate, 3)),
std.error = sprintf("%.3f", round(std.error, 3)),
statistic = sprintf("%.3f", round(statistic, 3)),
conf.low  = sprintf("%.3f", round(conf.low, 3)),
conf.high = sprintf("%.3f", round(conf.high, 3))
)
colnames(rq2_table) <- c(
"Variable", "Estimate", "Std Error", "t-value", "p-value",
"2.5% CI", "97.5% CI"
)
rownames(rq2_table) <- NULL
kable(
rq2_table,
caption = "Ordinal logistic regression model for regional happiness group (region-clustered robust SEs)",
booktabs = TRUE,
longtable = FALSE,
linesep  = "",
align    = c("l", "c", "c", "c", "c", "c", "c")
) %>%
kableExtra::kable_styling(full_width = FALSE, font_size = 10)
beta_names <- names(coef(rq2_model))
se_beta    <- se_robust_all[beta_names]
z_crit <- qnorm(0.975)
ci_low  <- coef(rq2_model) - z_crit * se_beta
ci_high <- coef(rq2_model) + z_crit * se_beta
exp_coefs_robust <- exp(cbind(
OR      = coef(rq2_model),
`2.5 %` = ci_low,
`97.5 %`= ci_high
))
rq2_or_df <- data.frame(
term     = rownames(exp_coefs_robust),
OR       = exp_coefs_robust[, "OR"],
conf.low = exp_coefs_robust[, "2.5 %"],
conf.high= exp_coefs_robust[, "97.5 %"],
stringsAsFactors = FALSE
)
p_df <- data.frame(
term    = rownames(ctable_robust),
p.value = ctable_robust[, "p value"],
stringsAsFactors = FALSE
) %>%
filter(term %in% rq2_or_df$term)
rq2_or_table <- rq2_or_df %>%
left_join(p_df, by = "term") %>%
mutate(
term = dplyr::recode(
term,
"generosity_index"               = "Generosity index",
"freedom_index"                  = "Freedom index",
"lifeexp_index"                  = "Life expectancy index",
"gdp_index"                      = "GDP per capita index",
"family_index"                   = "Family index",
"trust_index"                    = "Trust index",
"year"                           = "Year",
"generosity_index:freedom_index" = "Generosity × Freedom"
),
p.value  = ifelse(p.value < 0.001, "<0.001",
sprintf("%.3f", round(p.value, 3))),
OR       = sprintf("%.3f", round(OR, 3)),
conf.low = sprintf("%.3f", round(conf.low, 3)),
conf.high= sprintf("%.3f", round(conf.high, 3))
)
colnames(rq2_or_table) <- c(
"Variable", "Odds Ratio", "2.5% CI", "97.5% CI", "p-value"
)
rownames(rq2_or_table) <- NULL
kable(
rq2_or_table,
caption = "Odds ratios from ordinal logistic regression for regional happiness group (region-clustered robust SEs)",
booktabs = TRUE,
longtable = FALSE,
linesep  = "",
align    = c("l", "c", "c", "c", "c")
) %>%
kable_styling(full_width = FALSE, font_size = 10)
ggeffects::predict_response(
rq2_model,
terms = c("generosity_index [all]", "freedom_index")
) |>
plot() +
labs(
title = "Predicted Probabilities of Regional Happiness Group",
x = "Generosity Index",
y = "Predicted Probability",
color = "Freedom Index",
fill  = "Freedom Index"
) +
theme_bw(base_size = 8,base_family = "serif") +
theme(
text = element_text( size = 8),
plot.title = element_text(face = "bold")
)
mf <- model.frame(rq2_model)
truth <- mf$Region_Happy_Group
pred_class <- predict(rq2_model)
truth <- factor(truth, levels = levels(truth))
pred_class <- factor(pred_class, levels = levels(truth))
cm <- confusionMatrix(pred_class, truth)
cm_counts <- as.data.frame.matrix(cm$table)
cm_table <- cm_counts %>%
mutate(Prediction = rownames(cm_counts)) %>%
dplyr::select(Prediction, Low, Medium, High)
kable(
cm_table,
caption = "Confusion Matrix for Ordinal Logistic Regression (Regional Happiness Group)",
booktabs = TRUE,
align = c("l", "c", "c", "c")
) %>%
kable_styling(full_width = FALSE, font_size = 10)
par(mfrow = c(2,2),
mar = c(4,4,2,1),
cex = 0.9,
cex.axis = 0.9,
cex.lab = 0.9,
cex.main = 1.1)
plot(rq1_model)
par(mfrow = c(2,2),
mar = c(4,4,2,1),
cex = 0.9,
cex.axis = 0.9,
cex.lab = 0.9,
cex.main = 1.1)
plot(rq1_model)
fig.width = 6, fig.height = 4}
rq1_model <- lm(
score ~ lifeexp_index * gdp_index +
lifeexp_index * year +
gdp_index * year +
family_index +
freedom_index +
trust_index +
generosity_index +
year,
data = happiness
)
gdp_q <- quantile(happiness$gdp_index, c(0.10, 0.50, 0.90), na.rm = TRUE)
gdp_levels <- c(
"Low GDP"     = gdp_q[1],
"Median GDP"  = gdp_q[2],
"High GDP"    = gdp_q[3]
)
life_exp_range <- seq(
min(happiness$lifeexp_index, na.rm = TRUE),
max(happiness$lifeexp_index, na.rm = TRUE),
length.out = 120
)
plot_data <- lapply(names(gdp_levels), function(level_name) {
data.frame(
lifeexp_index    = life_exp_range,
gdp_index        = gdp_levels[[level_name]],
GDP_Level        = level_name,
family_index     = mean(happiness$family_index, na.rm = TRUE),
freedom_index    = mean(happiness$freedom_index, na.rm = TRUE),
trust_index      = mean(happiness$trust_index, na.rm = TRUE),
generosity_index = mean(happiness$generosity_index, na.rm = TRUE),
year             = mean(happiness$year, na.rm = TRUE)
)
}) |> bind_rows()
preds <- predict(rq1_model, newdata = plot_data, interval = "confidence")
plot_data <- cbind(plot_data, preds)
ggplot() +
geom_point(
data = happiness,
aes(x = lifeexp_index, y = score, colour = gdp_index),
alpha = 0.5, size = 1.4
) +
geom_line(
data = plot_data,
aes(x = lifeexp_index, y = fit, linetype = GDP_Level),
linewidth = 1.2,
colour = "black"
) +
geom_ribbon(
data = plot_data,
aes(x = lifeexp_index, ymin = lwr, ymax = upr, group = GDP_Level),
fill = "grey70", alpha = 0.15
) +
scale_colour_viridis_c() +
labs(
title    = "Observed Happiness and Modelled Interaction between Life Expectancy and GDP",
subtitle = "Fitted lines represent predictions at the 10th, 50th, and 90th percentiles of the GDP index",
x        = "Life expectancy index",
y        = "Happiness score (observed)",
colour   = "GDP index (observed)",
linetype = "GDP index level"
) +
theme_bw(base_size = 8, base_family = "serif") +
theme(
plot.title = element_text(face = "bold")
)
rq1_model <- lm(
score ~ lifeexp_index * gdp_index +
lifeexp_index * year +
gdp_index * year +
family_index +
freedom_index +
trust_index +
generosity_index +
year,
data = happiness
)
gdp_q <- quantile(happiness$gdp_index, c(0.10, 0.50, 0.90), na.rm = TRUE)
gdp_levels <- c(
"Low GDP"     = gdp_q[1],
"Median GDP"  = gdp_q[2],
"High GDP"    = gdp_q[3]
)
life_exp_range <- seq(
min(happiness$lifeexp_index, na.rm = TRUE),
max(happiness$lifeexp_index, na.rm = TRUE),
length.out = 120
)
plot_data <- lapply(names(gdp_levels), function(level_name) {
data.frame(
lifeexp_index    = life_exp_range,
gdp_index        = gdp_levels[[level_name]],
GDP_Level        = level_name,
family_index     = mean(happiness$family_index, na.rm = TRUE),
freedom_index    = mean(happiness$freedom_index, na.rm = TRUE),
trust_index      = mean(happiness$trust_index, na.rm = TRUE),
generosity_index = mean(happiness$generosity_index, na.rm = TRUE),
year             = mean(happiness$year, na.rm = TRUE)
)
}) |> bind_rows()
preds <- predict(rq1_model, newdata = plot_data, interval = "confidence")
plot_data <- cbind(plot_data, preds)
ggplot() +
geom_point(
data = happiness,
aes(x = lifeexp_index, y = score, colour = gdp_index),
alpha = 0.5, size = 1.4
) +
geom_line(
data = plot_data,
aes(x = lifeexp_index, y = fit, linetype = GDP_Level),
linewidth = 1.2,
colour = "black"
) +
geom_ribbon(
data = plot_data,
aes(x = lifeexp_index, ymin = lwr, ymax = upr, group = GDP_Level),
fill = "grey70", alpha = 0.15
) +
scale_colour_viridis_c() +
labs(
title    = "Observed Happiness and Modelled Interaction between Life Expectancy and GDP",
subtitle = "Fitted lines represent predictions at the 10th, 50th, and 90th percentiles of the GDP index",
x        = "Life expectancy index",
y        = "Happiness score (observed)",
colour   = "GDP index (observed)",
linetype = "GDP index level"
) +
theme_bw(base_size = 8, base_family = "serif") +
theme(
plot.title = element_text(face = "bold")
)
rq1_model <- lm(
score ~ lifeexp_index * gdp_index +
lifeexp_index * year +
gdp_index * year +
family_index +
freedom_index +
trust_index +
generosity_index +
year,
data = happiness
)
gdp_q <- quantile(happiness$gdp_index, c(0.10, 0.50, 0.90), na.rm = TRUE)
gdp_levels <- c(
"Low GDP"     = gdp_q[1],
"Median GDP"  = gdp_q[2],
"High GDP"    = gdp_q[3]
)
life_exp_range <- seq(
min(happiness$lifeexp_index, na.rm = TRUE),
max(happiness$lifeexp_index, na.rm = TRUE),
length.out = 120
)
plot_data <- lapply(names(gdp_levels), function(level_name) {
data.frame(
lifeexp_index    = life_exp_range,
gdp_index        = gdp_levels[[level_name]],
GDP_Level        = level_name,
family_index     = mean(happiness$family_index, na.rm = TRUE),
freedom_index    = mean(happiness$freedom_index, na.rm = TRUE),
trust_index      = mean(happiness$trust_index, na.rm = TRUE),
generosity_index = mean(happiness$generosity_index, na.rm = TRUE),
year             = mean(happiness$year, na.rm = TRUE)
)
}) |> bind_rows()
preds <- predict(rq1_model, newdata = plot_data, interval = "confidence")
plot_data <- cbind(plot_data, preds)
ggplot() +
geom_point(
data = happiness,
aes(x = lifeexp_index, y = score, colour = gdp_index),
alpha = 0.5, size = 1.4
) +
geom_line(
data = plot_data,
aes(x = lifeexp_index, y = fit, linetype = GDP_Level),
linewidth = 1.2,
colour = "black"
) +
geom_ribbon(
data = plot_data,
aes(x = lifeexp_index, ymin = lwr, ymax = upr, group = GDP_Level),
fill = "grey70", alpha = 0.15
) +
scale_colour_viridis_c() +
labs(
title    = "Observed Happiness and Modelled Interaction between Life Expectancy and GDP",
subtitle = "Fitted lines represent predictions at the 10th, 50th, and 90th percentiles of the GDP index",
x        = "Life expectancy index",
y        = "Happiness score (observed)",
colour   = "GDP index (observed)",
linetype = "GDP index level"
) +
theme_bw(base_size = 8, base_family = "serif") +
theme(
plot.title = element_text(face = "bold")
)
